import re
import json

from scrapy import Spider, Item, Field




class ExploitDBItems(Item):
	exploit_id = Field()
	description=Field()
	cve = Field()
	exploit_verification= Field()
	date_published= Field()
	type= Field()
	platform=Field()
	
class ExploitDB(Spider):
    name = "Airbnb"
    start_urls = ["https://www.exploit-db.com/exploits/{0}/".format(n) for n in range(42166,2,-1)]

    download_delay = 0.5
    def get_extracted(value, index=0):
	try:
		return value[index]
	except:
		return ""

    def parse(self, response):
        item = ExploitDBItems()
        try:
		   id=response.xpath("/html/body/div[1]/div[2]/div/main/section/div/div[1]/div[1]/div/table/tr[1]/td[1]/text()").extract()[0]
		   date= response.xpath("/html/body/div[1]/div[2]/div/main/section/div/div[1]/div[1]/div/table/tr[1]/td[3]/text()").extract()[0]
		   cve=response.xpath("/html/body/div[1]/div[2]/div/main/section/div/div[1]/div[1]/div/table/tr[2]/td[1]/a/text()").extract()
		   if len(cve)==0:
			cve="N/A"
		   else:
		    cve=cve[0].encode()
		   type=response.xpath("/html/body/div[1]/div[2]/div/main/section/div/div[1]/div[1]/div/table/tr[2]/td[2]/a/text()").extract()[0].encode()
		   platform=response.xpath("/html/body/div[1]/div[2]/div/main/section/div/div[1]/div[1]/div/table/tr[2]/td[3]/a/text()").extract()[0].encode()
		   verified=response.xpath("/html/body/div[1]/div[2]/div/main/section/div/div[1]/div[1]/div/table/tr[3]/td[1]/img/@title").extract()
		   if len(verified)==0:
		    verified=response.xpath("/html/body/div[1]/div[2]/div/main/section/div/div[1]/div[1]/div/table/tr[4]/td[1]/img/@title").extract()[0].encode()
		   else:
		    verified=verified[0].encode()
		   if verified=="Verified":
			verified=2
		   elif verified=="Waiting verification":
		    verified=1
		   item["exploit_id"] = id.encode()[2:]
		   item["description"]= response.xpath('/html/body/div[1]/div[1]/div/div/h1/text()').extract()[0].encode()
		   item["date_published"]= date.encode()[2:]
		   item["cve"]=cve.strip()
		   item["type"]=type.strip()
		   item["platform"]=platform.strip()
		   item["exploit_verification"]=verified
        except IndexError:
            print("!!!!!!!!!!!!!!!!!!!!!!!!!!!!SOME WENT WRONG WITH XPATH!!!!!!!!!!!!!!!!!!!!!")
        return item
